## 节点信息接口文档



## 全局设置：

- 所有的变量类型都是字符串或整数
- 接口暂定，联调时候继续优化。



类型 controller dns dhcp

名称 hostname

ip

在线状态



### 0 dashboard的dns部分

#### 0.1 top请求域名和top请求ip

| 功能     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 接口功能 | 获取top域名和top ip                                          |
| 接口地址 | /apis/linkingthing/dashboard/v1/dashdns                      |
| 请求方式 | GET                                                          |
| 请求参数 | 无                                                           |
| 请求示例 | http://10.0.0.15:1234/apis/linkingthing/dashboard/v1/dashdns |

- 返回数据示例

{
	"status": "200",
	"data": {
		"ips": [{
			"key": "10.0.0.19",
			"doc_count": 12
		}, {
			"key": "10.0.0.29",
			"doc_count": 1
		}, {
			"key": "10.0.0.39",
			"doc_count": 1
		}],
		"domains": [{
			"key": "mail.baidu.com",
			"doc_count": 6
		}, {
			"key": "www.baidu.com",
			"doc_count": 4
		}, {
			"key": "19.0.0.10",
			"doc_count": 3
		}, {
			"key": "addr.arpa",
			"doc_count": 3
		}, {
			"key": "in",
			"doc_count": 3
		}, {
			"key": "www.test.com",
			"doc_count": 1
		}]
	},
	"message": "成功"
}





### 1 获取服务器列表和状态



| 功能     | 描述                                                    |
| -------- | ------------------------------------------------------- |
| 接口功能 | 进入页面，前端向服务端获取当前系统的节点的列表，        |
| 接口地址 | /apis/linkingthing/node/v1/servers                      |
| 请求方式 | POST                                                    |
| 请求参数 | 无                                                      |
| 请求示例 | http://10.0.0.55:1234/apis/linkingthing/node/v1/servers |

- 返回数据示例

{
	"status": "success",
	"message": "ok",
	"data": [{
		"hostname": "ip-24",//主机名
		"promHost": "10.0.0.24",
		"promPort": "9090",
		"ip": "10.0.0.24",//本机的ip
		"role": "dhcp",//角色
		"state": 1,//状态 1在线 2告警(负载高)
		"onTime": 1582707582, //机器启动时候的时间戳，暂时未用
		"parentIP": "10.0.0.15" //父节点ip 0.0.0.0是controller 没有父节点
	}, {
		"hostname": "ip-15",
		"promHost": "10.0.0.24",
		"promPort": "9090",
		"ip": "10.0.0.15",
		"role": "controller",
		"state": 1,
		"onTime": 1582707619,
		"parentIP": "0.0.0.0" //父节点ip 0.0.0.0是controller 没有父节点
	}]
}



### 2 获取节点信息



| 功能     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 接口功能 | 进入页面，前端向服务端获取当前系统的节点的列表，默认显示第一个节点的监控信息。点击其他节点，获取该节点的详细信息 |
| 接口地址 | /apis/linkingthing/node/v1/nodes                             |
| 请求方式 | POST                                                         |
| 请求参数 | 字段名 node， 类型 string，进入首页是不传，其他情况传ip地址即可（如10.0.0.15）<br />字段名 type， 类型 string。取值（cpu, mem, disk, qps, all）不传参数，默认是all，**不传即可** |
| 请求示例 | http://10.0.0.55:1234/apis/linkingthing/node/v1/nodes?node=10.0.0.36 |

- 返回数据示例

{
	"status": "success", //status: success代表成功，其他代表失败
	"data": {
		"nodes": {

​          //nodes是树形结构的节点列表，每个节点是ip为索引的数组
​			"10.0.0.15": { //ip为索引的数组来区分每个节点
​				"hostname": "ip-15", //主机名
​				"promHost": "10.0.0.15:9092", //监控服务的主机（第一期用不到）
​				"promPort": "9100", //监控服务的端口(第一期用不到)
​				"ip": "10.0.0.15",//节点的ip
​				"role": 0, //节点的类型，0是控制器，1是数据库，2是消息队列
​				"state": 1, //节点的在线状态 0是下线，1是在线
​				"onTime": 1579092655 //节点的最近上线时间的时间戳
​			},
​			"10.0.0.23": {
​				"hostname": "ip-15",
​				"promHost": "10.0.0.15:9092",
​				"promPort": "9100",
​				"ip": "10.0.0.23",
​				"role": 1,
​				"state": 1,
​				"onTime": 1579092655
​			}
​		},
​		"usage": { //各种指标的利用率
​			"10.0.0.15": { //节点的ip
​				"cpu": "4.87", //cpu利用率
​				"mem": "23.78",//内存利用率
​				"disk": "20.47",//磁盘利用率
​				"qps": "13.15"//qps数字
​				},
​			"10.0.0.23": {
​				"cpu": "5.63",
​				"mem": "23.78",
​				"disk": "20.47",
​				"qps": "13.15"
​			}
​		}
​	},
​	"message": "ok"
}





### 3. 获取节点历史信息

| 功能     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 接口功能 | cpu 内存 内存利用率中，点击饼图，显示该项的历史数据          |
| 接口地址 | /apis/linkingthing/node/v1/hists                             |
| 请求方式 | POST                                                         |
| 请求参数 | node: string类型 接口一中服务端传来的字段，节点的ip<br />type('cpu','mem','disk','qps'):  string类型 获取哪种类型，目前支持的分别是cpu利用率，内存利用率，磁盘利用率和dns的qps<br />start:  开始的秒级时间戳 如1578739534.594 <br />end:  结束的秒级时间戳 如1578739534.594 <br />step:   间隔的秒数 如 150 |
| 请求示例 | http://10.0.0.55:1234/apis/linkingthing/node/v1/hists?node=10.0.0.36&start=1579150980&end=1579154580&step=323&type=cpu |
|          |                                                              |

- 返回数据示例

{
    "status": "success",
    "data":  [{
            "metric": {
                "node": "10.0.0.15"
            },
            "values": [
                [1579178577.588, "5.166666666045799"],
                [1579178591.588, "5.166666666045799"],
                [1579178605.588, "4.233333334171533"],
                [1579178619.588, "4.599999999627471"],
                [1579178633.588, "4.333333333488554"],
                [1579178647.588, "4.733333333861083"],
                [1579178661.588, "4.3666666660768385"],
                [1579178675.588, "5.699999999875828"],
                [1579178689.588, "4.366666666852922"],
                [1579178703.588, "4.8666666665425"],
                [1579178717.588, "4.166666666666671"],
                [1579178731.588, "4.466666666946068"],
                [1579178745.588, "4.633333332991853"],
                [1579178759.588, "5.233333333550647"],
                [1579178773.588, "4.400000000217304"],
                [1579178787.588, "5.166666666821882"]
            ]
        }, {
            "metric": {
                "node": "10.0.0.23"
            },
            "values": [
                [1579175189.588, "1.2666666662941424"],
                [1579175203.588, "0.9000000008381903"],
                [1579175217.588, "0.8333333325572454"],
                [1579175231.588, "0.8000000007450581"],
                [1579175245.588, "0.9333333326503634"],
                [1579175259.588, "0.8333333341094402"],
                [1579175273.588, "0.8333333325572454"],
                [1579175287.588, "0.8666666666977108"],
                [1579178773.588, "0.8999999992859813"],
                [1579178787.588, "1.0000000009313226"]
            ]
        }]
}



- 返回数据字段说明:
  - status: success代表成功，其他代表失败
  - values是指标的历史数据集合，每一项是个数组，第一个(1578696706.594)是毫秒级的时间戳，第二个("0.36666666623203525")是要获取的值。



## 4, 仪表盘板块的dhcp模块

#### 4.1 dhcp报文统计

| 功能     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 接口功能 | 获取top域名和top ip                                          |
| 接口地址 | /apis/linkingthing/node/v1/hists                             |
| 请求方式 | GET                                                          |
| 请求参数 | 同 3. 获取节点历史信息                                       |
| 请求示例 | http://10.0.0.55:1234/apis/linkingthing/node/v1/hists?node=10.0.0.55&start=1583164800&end=1584028800&step=323&type=dhcppacket |

- 返回数据示例

```
{
	"status": "success",
	"data": {
		"metric": {
			"node": "10.0.0.55"
		},
		"values": [
			[1584007184, "20"],
			[1584007507, "20"],
			[1584007830, "20"],
			[1584008153, "20"],
			[1584008476, "20"],
			[1584008799, "20"],
			[1584009122, "20"],
			[1584009445, "20"],
			[1584009768, "20"],
			[1584010091, "20"],
			[1584010414, "20"],
			[1584010737, "20"],
			[1584011060, "20"],
			[1584011383, "20"],
			[1584011706, "20"],
			[1584012029, "20"],
			[1584012352, "20"],
			[1584012675, "20"],
			[1584012998, "20"],
			[1584013321, "20"],
			[1584013644, "20"],
			[1584013967, "20"],
			[1584014290, "20"],
			[1584014613, "20"],
			[1584014936, "20"]
		]
	},
	"message": "ok"
}
```

#### 4.2 IP地址分配状态

| 功能     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 接口功能 | IP地址分配状态                                               |
| 接口地址 | /apis/linkingthing/dashboard/v1/dhcpassign                   |
| 请求方式 | GET                                                          |
| 请求参数 | 同 3. 获取节点历史信息                                       |
| 请求示例 | http://10.0.0.55:1234/apis/linkingthing/dashboard/v1/dhcpassign |
|          |                                                              |

- 返回数据示例

```
{
	"status": "success",
	"message": "成功",
	"data": [{
		"id": 1, //id 页面不用
		"name": "192.168.1.0/24:1", //子网名称
		"addr": "192.168.1.0/24", //网络地址
		"total": 101, //地址总量
		"used": 20 //已分配。  
		    //剩余数量=total - used
	}, {
		"id": 2,
		"name": "192.168.13.0/24:2",
		"addr": "192.168.13.0/24",
		"total": 101,
		"used": 20
	}]
}
```



#### 4.3 dhcp使用率

| 功能     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 接口功能 | dhcp使用率                                                   |
| 接口地址 | /apis/linkingthing/node/v1/hists                             |
| 请求方式 | GET                                                          |
| 请求参数 | 同 3. 获取节点历史信息                                       |
| 请求示例 | http://10.0.0.55:1234/apis/linkingthing/node/v1/hists?node=10.0.0.55&start=1583164800&end=1585497600&step=1323&type=dhcpusage |
| 备注     | 1583164800 ==> 2020/3/3 0:0:0    1585497600 ==> 2020/3/30 0:0:0 |
|          |                                                              |

- 返回数据示例

```
{
	"status": "success",
	"data": {
		"metric": {
			"node": "10.0.0.55"
		},
		"values": [
			[1584179541, "0"],
			[1584180864, "13"],
			[1584184833, "19.8"]
		]
	},
	"message": "ok"
}
```



#### 4.4 leases总量统计

| 功能     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 接口功能 | leases总量统计                                               |
| 接口地址 | /apis/linkingthing/node/v1/hists                             |
| 请求方式 | GET                                                          |
| 请求参数 | 同 3. 获取节点历史信息                                       |
| 请求示例 | http://10.0.0.55:1234/apis/linkingthing/node/v1/hists?node=10.0.0.55&start=1583164800&end=1585497600&step=323&type=dhcplease |
| 备注     | 1583164800 ==> 2020/3/3 0:0:0    1585497600 ==> 2020/3/30 0:0:0 |
|          |                                                              |

- 返回数据示例

```
{
	"status": "success",
	"data": {
		"metric": {
			"node": "10.0.0.55"
		},
		"values": [
			[1584061794, "33"],
			[1584063117, "33"],
			[1584064440, "33"],
			[1584065763, "33"],
			[1584067086, "33"],
			[1584068409, "33"],
			[1584069732, "33"],
			[1584071055, "33"],
			[1584072378, "33"],
			[1584073701, "33"],
			[1584075024, "40"],
			[1584076347, "40"],
			[1584077670, "40"],
			[1584078993, "40"],
			[1584080316, "40"],
			[1584081639, "40"],
			[1584082962, "40"],
			[1584084285, "40"],
			[1584085608, "40"],
			[1584086931, "40"],
			[1584088254, "40"],
			[1584089577, "40"],
			[1584090900, "40"],
			[1584092223, "40"],
			[1584093546, "40"],
			[1584094869, "40"],
			[1584096192, "40"],
			[1584097515, "40"],
			[1584098838, "40"],
			[1584100161, "40"]
		]
	},
	"message": "ok"
}
```

